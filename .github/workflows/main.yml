name: Discord Bot

on:
  push:
    branches: [ main ]
  workflow_dispatch:
  schedule:
    - cron: '*/5 * * * *'  # 5分ごとにチェック

jobs:
  run-bot:
    runs-on: ubuntu-latest
    
    # 同じコミットに対して同時に複数のワークフローが実行されないようにする
    concurrency: 
      group: bot-${{ github.ref }}
      cancel-in-progress: true
    
    steps:
    - uses: actions/checkout@v3
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0
    
    - name: Set timezone to Japan
      run: |
        sudo timedatectl set-timezone Asia/Tokyo
        date
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.13'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        # jqをインストール
        sudo apt-get update && sudo apt-get install -y jq
    
    - name: Setup data directory
      run: |
        mkdir -p logs temp backups data/posts data/replies data/likes
        chmod 755 logs temp backups data data/posts data/replies data/likes
    
    - name: Preserve existing data
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # 既存のデータを保護（上書きしない）
        if [ -d "data" ]; then
          echo "✅ 既存のdataディレクトリを保護します"
          echo "📊 データ情報:"
          find data -name "*.json" | wc -l
          echo "投稿数: $(find data/posts -name "*.json" | wc -l)"
          echo "リプライ数: $(find data/replies -name "*.json" | wc -l)"
          echo "いいね数: $(find data/likes -name "*.json" | wc -l)"
        else
          echo "⚠️ dataディレクトリが見つかりません"
          echo "🔄 GitHubから取得を試みます..."
          git fetch origin main
          git checkout origin/main -- data/ 2>/dev/null || echo "⚠️ GitHubからの取得に失敗しました"
          
          if [ -d "data" ]; then
            echo "✅ GitHubからdataディレクトリを取得しました"
          else
            echo "⚠️ GitHubにもdataディレクトリがありません"
            echo "📝 新規に空のデータディレクトリを作成します"
            mkdir -p data/posts data/replies data/likes
          fi
        fi
    
    - name: Check if data exists
      run: |
        # データの状態を確認
        if [ -d "data" ]; then
          echo "既存のデータディレクトリサイズ: $(du -sh data | cut -f1)"
          if [ "$(find data -name "*.json" | wc -l)" -gt 0 ]; then
            echo "✅ 既存のデータを使用します（データあり）"
            
            # データにファイルがあるか確認
            POST_COUNT=$(find data/posts -name "*.json" | wc -l)
            REPLY_COUNT=$(find data/replies -name "*.json" | wc -l)
            LIKE_COUNT=$(find data/likes -name "*.json" | wc -l)
            echo "📊 データの投稿数: $POST_COUNT"
            echo "📊 データのリプライ数: $REPLY_COUNT"
            echo "📊 データのいいね数: $LIKE_COUNT"
            
            if [ "$POST_COUNT" -gt 0 ]; then
              echo "✅ データにデータが存在します。既存データを保護します。"
            else
              echo "⚠️ データが存在しません"
            fi
          else
            echo "⚠️ データディレクトリが存在しません"
            echo "🔄 GitHubから取得を試みます..."
            git pull origin main || echo "⚠️ GitHubからの取得に失敗しました"
            
            if [ -d "data" ]; then
              echo "✅ GitHubからデータディレクトリを取得しました"
            else
              echo "⚠️ GitHubにもデータディレクトリがありません"
              echo "📝 新規に空のデータディレクトリを作成します"
              mkdir -p data/posts data/replies data/likes
            fi
          fi
          
          # 最終的なデータ状態を確認
          if [ -d "data" ]; then
            echo "📊 最終データディレクトリサイズ: $(du -sh data | cut -f1)"
            FINAL_POST_COUNT=$(find data/posts -name "*.json" | wc -l)
            FINAL_REPLY_COUNT=$(find data/replies -name "*.json" | wc -l)
            FINAL_LIKE_COUNT=$(find data/likes -name "*.json" | wc -l)
            echo "📊 最終投稿数: $FINAL_POST_COUNT"
            echo "📊 最終リプライ数: $FINAL_REPLY_COUNT"
            echo "📊 最終いいね数: $FINAL_LIKE_COUNT"
          else
            echo "⚠️ 最終データディレクトリは存在しません"
          fi
        fi
    
    - name: Check if bot is running
      id: check_bot
      env:
        DISCORD_TOKEN: ${{ secrets.DISCORD_TOKEN }}
        APPLICATION_ID: ${{ secrets.APPLICATION_ID }}
        ALLOWED_CHANNEL_IDS: ${{ secrets.ALLOWED_CHANNEL_ID }}
      run: |
        # 既存の実行中のワークフローをチェック
        RUNNING_JOBS=$(curl -s -H "Authorization: token ${{ github.token }}" \
          "https://api.github.com/repos/${{ github.repository }}/actions/runs?status=in_progress" | \
          jq -r '.workflow_runs[] | select(.id != ${{ github.run_id }}) | .id')
        
        if [ -z "$RUNNING_JOBS" ]; then
          echo "ボットが実行されていないため、起動します"
          echo "RUN_BOT=true" >> $GITHUB_ENV
        else
          echo "ボットは既に実行中です"
          echo "RUN_BOT=false" >> $GITHUB_ENV
        fi
    
    - name: Run bot
      if: env.RUN_BOT == 'true'
      env:
        DISCORD_TOKEN: ${{ secrets.DISCORD_TOKEN }}
        APPLICATION_ID: ${{ secrets.APPLICATION_ID }}
        ALLOWED_CHANNEL_IDS: ${{ secrets.ALLOWED_CHANNEL_ID }}
      run: |
        # ボット起動時にデータディレクトリを指定
        export DATA_DIR="data"
        
        # 既存のプロセスを終了
        pkill -f "python.*bot.py" || true
        
        # ボットを起動
        mkdir -p logs temp
        nohup python bot.py > logs/bot.log 2>&1 &
        echo $! > temp/bot.pid
        
        # 起動を待つ
        sleep 10
        
        # ログを表示
        cat logs/bot.log
        
        # プロセスが実行中か確認
        if ! ps -p $(cat temp/bot.pid) > /dev/null; then
          echo "ボットの起動に失敗しました"
          cat logs/bot.log
          exit 1
        fi
        
        echo "ボットが正常に起動しました"
        
        # 無限ループで待機
        while true; do
          # ボットがまだ実行中か確認
          if ! ps -p $(cat temp/bot.pid) > /dev/null; then
            echo "ボットが終了しました。再起動します..."
            # 再起動
            export DATA_DIR="data"
            nohup python bot.py > logs/bot.log 2>&1 &
            echo $! > temp/bot.pid
            sleep 10
          fi
          # 10秒ごとにチェック（超高速対応）
          sleep 10
        done
    
    - name: Skip automatic backup
      run: |
        echo "ℹ️ 30分ごとの自動バックアップをスキップします"
        echo "📊 データはGitHub同期で保護されています"
        if [ -d "data" ]; then
          echo "✅ データディレクトリサイズ: $(du -sh data | cut -f1)"
          echo "📊 投稿数: $(find data/posts -name "*.json" | wc -l)"
        else
          echo "⚠️ データディレクトリが存在しません"
        fi
    
    - name: Commit database changes
      if: always()  # ボットがクラッシュしても必ず実行
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # データの変更をチェック
        DATA_CHANGED=false
        
        # データディレクトリに変更があるか確認
        if [ -d "data" ]; then
          # 最新のタイムスタンプを取得
          LATEST_TIMESTAMP=$(find data -name "*.json" -exec stat -c %Y%m%d%H%M.%S {} + | sort -r | head -n 1 | cut -d' ' -f6 2>/dev/null)
          TIMESTAMP_FILE="data/.last_sync"
          
          # タイムスタンプファイルが存在するか確認
          if [ -f "$TIMESTAMP_FILE" ]; then
            SAVED_TIMESTAMP=$(cat "$TIMESTAMP_FILE" 2>/dev/null)
            if [ "$LATEST_TIMESTAMP" != "$SAVED_TIMESTAMP" ]; then
              DATA_CHANGED=true
              echo "📝 データに変更があります"
            fi
          else
            DATA_CHANGED=true
            echo "📝 データに変更があります（タイムスタンプファイルなし）"
          fi
          
          # タイムスタンプファイルを更新
          echo "$(date '+%Y%m%d%H%M.%S')" > "$TIMESTAMP_FILE"
        else
          # データディレクトリがない場合は変更なし
          DATA_CHANGED=false
          echo "データディレクトリがありません"
        fi
        
        # データが変更されている場合のみコミット
        if [ "$DATA_CHANGED" = true ]; then
          echo "📝 データをGitHubに保存します..."
          git add data/
          
          # コミットをリトライ（最大3回に減らして整理）
          for i in {1..3}; do
            if git commit -m "🔄 Auto-sync data - $(date '+%Y-%m-%d %H:%M:%S')"; then
              echo "✅ データをコミットしました (試行 $i)"
              break
            else
              echo "⚠️ コミット失敗、リトライします (試行 $i/3)"
              git pull --rebase origin main || true
              sleep 3
              # 最終手段：1つのクリーンなコミットにまとめる
              if [ $i -eq 3 ]; then
                echo "🔥 最終手段：クリーンなコミットを実行します"
                git add -A
                git commit -m "🔄 Data sync - $(date '+%Y-%m-%d %H:%M:%S')" || true
              fi
            fi
          done
          
          # プッシュをリトライ（最大3回に減らす）
          for i in {1..3}; do
            if git push origin main; then
              echo "✅ データをプッシュしました (試行 $i)"
              break
            else
              echo "⚠️ プッシュ失敗、リトライします (試行 $i/3)"
              git pull --rebase origin main || true
              sleep 3
              # 最終手段：1回のみの強制プッシュ
              if [ $i -eq 3 ]; then
                echo "🔥 最終手段：強制プッシュを実行します"
                git push origin main --force || true
              fi
            fi
          done
        else
          echo "ℹ️ データに変更はありません"
        fi
    
    - name: Show logs
      if: always()
      run: |
        if [ -f "logs/bot.log" ]; then
          echo "=== 最終ログ ==="
          echo "=== DEBUGログを含む全ログ ==="
          grep -E "(DEBUG|ERROR|WARNING)" logs/bot.log || echo "DEBUGログが見つかりません"
          echo "=== 最終50行 ==="
          tail -n 50 logs/bot.log
        fi
        if [ -d "data" ]; then
          echo "=== データ情報 ==="
          echo "📁 データディレクトリサイズ: $(du -sh data | cut -f1)"
          echo "📊 投稿数: $(find data/posts -name "*.json" | wc -l)"
          echo "📊 リプライ数: $(find data/replies -name "*.json" | wc -l)"
          echo "📊 いいね数: $(find data/likes -name "*.json" | wc -l)"
          echo "=== 最近の投稿 ==="
          find data/posts -name "*.json" -exec ls -lt {} + | head -5 || echo "投稿データが取得できません"
        fi
        
        if [ -d "backups" ]; then
          echo "=== バックアップ情報 ==="
          echo "📁 バックアップファイル一覧:"
          ls -la backups/ 2>/dev/null || echo "バックアップディレクトリがありません"
          BACKUP_COUNT=$(find backups -name "*.json" 2>/dev/null | wc -l)
          echo "📊 バックアップ数: $BACKUP_COUNT"
        fi
