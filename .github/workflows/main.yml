name: Discord Bot

on:
  push:
    branches: [ main ]
  workflow_dispatch:
  schedule:
    - cron: '*/30 * * * *'  # 30分ごとにチェック（UTC）

jobs:
  run-bot:
    runs-on: ubuntu-latest
    
    # 同じコミットに対して同時に複数のワークフローが実行されないようにする
    # ただし、データベース同期は確実に行う必要があるため、キャンセルは無効化
    concurrency: 
      group: bot-${{ github.ref }}
      cancel-in-progress: false
    
    steps:
    - uses: actions/checkout@v3
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0
    
    - name: Set timezone to Japan
      run: |
        sudo timedatectl set-timezone Asia/Tokyo
        date
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.13'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Setup database directory
      run: |
        mkdir -p logs temp backups
        chmod 755 logs temp backups
    
    - name: Preserve existing database
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # 既存のデータベースを保護（上書きしない）
        if [ -f "bot.db" ]; then
          echo "✅ 既存のbot.dbを保護します"
          echo "📊 データベース情報:"
          ls -la bot.db
          sqlite3 bot.db "SELECT COUNT(*) FROM thoughts;" 2>/dev/null || echo "テーブルが存在しません"
        else
          echo "⚠️ bot.dbが見つかりません"
          echo "🔄 GitHubから取得を試みます..."
          git fetch origin main
          git checkout origin/main -- bot.db 2>/dev/null || echo "⚠️ GitHubからの取得に失敗しました"
          
          if [ -f "bot.db" ]; then
            echo "✅ GitHubからbot.dbを取得しました"
          else
            echo "⚠️ GitHubにもbot.dbがありません"
            echo "📝 新規に空のデータベースを作成します"
            touch bot.db
          fi
        fi
    
    - name: Check if database exists
      run: |
        # データベースの状態を確認
        if [ -f "bot.db" ]; then
          echo "既存のデータベースサイズ: $(wc -c < bot.db) bytes"
          if [ -s "bot.db" ]; then
            echo "✅ 既存のデータベースを使用します（データあり）"
            
            # データベースにデータがあるか確認
            sqlite3 bot.db "SELECT COUNT(*) FROM thoughts;" > /tmp/db_count.txt 2>/dev/null || echo "0" > /tmp/db_count.txt
            DB_COUNT=$(cat /tmp/db_count.txt)
            echo "📊 データベースの投稿数: $DB_COUNT"
            
            if [ "$DB_COUNT" -gt 0 ]; then
              echo "✅ データベースにデータが存在します。既存データを保護します。"
              # 既存データを保護（上書きしない）
              if [ -f "bot.db" ]; then
                echo "⚠️ bot.db は無視します（既存データを保護）"
                # rm -f bot.db  # ← 削除：5分ごとにbot.dbを消さないようにする
              fi
            else
              echo "⚠️ データベースが存在しません"
              echo "🔄 GitHubから取得を試みます..."
              git fetch origin main
              git checkout origin/main -- bot.db 2>/dev/null || echo "⚠️ GitHubからの取得に失敗しました"
              
              if [ -f "bot.db" ] && [ -s "bot.db" ]; then
                echo "✅ GitHubからデータベースを取得しました"
              else
                echo "⚠️ GitHubにも有効なデータベースがありません"
                echo "🔄 バックアップから復元を試みます..."
                if [ -d "backup" ] && [ "$(ls -1 backup/*.db 2>/dev/null | wc -l)" -gt 0 ]; then
                  LATEST_BACKUP=$(ls -1t backup/*.db 2>/dev/null | head -n 1)
                  echo "📁 最新のバックアップ: $LATEST_BACKUP"
                  cp "$LATEST_BACKUP" bot.db
                  echo "✅ バックアップから復元しました"
                  
                  # 復元後の確認
                  RESTORED_COUNT=$(sqlite3 bot.db "SELECT COUNT(*) FROM thoughts;" 2>/dev/null || echo "0")
                  echo "📊 復元後の投稿数: $RESTORED_COUNT"
                  if [ "$RESTORED_COUNT" -gt 0 ]; then
                    echo "✅ データ復元に成功しました"
                  else
                    echo "⚠️ バックアップも空でした"
                  fi
                else
                  echo "⚠️ 利用可能なバックアップがありません"
                  echo "📝 新規に空のデータベースを作成します"
                  touch bot.db
                fi
              fi
            fi
          else
            echo "⚠️ 既存のデータベースは空です"
            # 上記の復元ロジックで処理されるため、ここでは何もしない
          fi
        else
          echo "⚠️ データベースが存在しません"
          echo "🔄 GitHubから取得を試みます..."
          git pull origin main || echo "⚠️ GitHubからの取得に失敗しました"
          
          if [ -f "bot.db" ]; then
            echo "✅ GitHubからデータベースを取得しました"
          else
            echo "⚠️ GitHubにもデータベースがありません"
            echo "🔄 バックアップから復元を試みます..."
            if [ -d "backup" ] && [ "$(ls -1 backup/*.db 2>/dev/null | wc -l)" -gt 0 ]; then
              LATEST_BACKUP=$(ls -1t backup/*.db 2>/dev/null | head -n 1)
              cp "$LATEST_BACKUP" bot.db
              echo "✅ バックアップから復元しました: $LATEST_BACKUP"
            else
              echo "❌ バックアップもありません"
              if [ ! -f "bot.db" ]; then
                echo "📝 新規に空のデータベースを作成します（既存ファイルはありません）"
                touch bot.db
              else
                echo "✅ 既存のbot.dbを保護します（上書しません）"
              fi
            fi
          fi
        fi
        
        # 最終的なデータベース状態を確認
        if [ -f "bot.db" ]; then
          echo "📊 最終データベースサイズ: $(wc -c < bot.db) bytes"
          if [ -s "bot.db" ]; then
            sqlite3 bot.db "SELECT COUNT(*) FROM thoughts;" > /tmp/final_count.txt 2>/dev/null || echo "0" > /tmp/final_count.txt
            FINAL_COUNT=$(cat /tmp/final_count.txt)
            echo "📊 最終投稿数: $FINAL_COUNT"
          else
            echo "⚠️ 最終データベースは空です"
          fi
        fi
    
    - name: Check if bot is running
      id: check_bot
      env:
        DISCORD_TOKEN: ${{ secrets.DISCORD_TOKEN }}
        ALLOWED_CHANNEL_IDS: ${{ secrets.ALLOWED_CHANNEL_ID }}
      run: |
        # 既存の実行中のワークフローをチェック
        RUNNING_JOBS=$(curl -s -H "Authorization: token ${{ github.token }}" \
          "https://api.github.com/repos/${{ github.repository }}/actions/runs?status=in_progress" | \
          jq -r '.workflow_runs[] | select(.id != ${{ github.run_id }}) | .id')
        
        if [ -z "$RUNNING_JOBS" ]; then
          echo "ボットが実行されていないため、起動します"
          echo "RUN_BOT=true" >> $GITHUB_ENV
        else
          echo "ボットは既に実行中です"
          echo "RUN_BOT=false" >> $GITHUB_ENV
        fi
    
    - name: Run bot
      if: env.RUN_BOT == 'true'
      env:
        DISCORD_TOKEN: ${{ secrets.DISCORD_TOKEN }}
        ALLOWED_CHANNEL_IDS: ${{ secrets.ALLOWED_CHANNEL_ID }}
      run: |
        # ボット起動時にデータベースパスを指定
        export DB_PATH="bot.db"
        
        # 既存のプロセスを終了
        pkill -f "python.*bot.py" || true
        
        # ボットを起動
        mkdir -p logs temp
        nohup python bot.py > logs/bot.log 2>&1 &
        echo $! > temp/bot.pid
        
        # 起動を待つ
        sleep 10
        
        # ログを表示
        cat logs/bot.log
        
        # プロセスが実行中か確認
        if ! ps -p $(cat temp/bot.pid) > /dev/null; then
          echo "ボットの起動に失敗しました"
          cat logs/bot.log
          exit 1
        fi
        
        echo "ボットが正常に起動しました"
        
        # 30分間実行して終了（30分後のワークフローが引き継ぐ）
        for i in {1..30}; do
          # ボットがまだ実行中か確認
          if ! ps -p $(cat temp/bot.pid) > /dev/null; then
            echo "ボットが終了しました。再起動します..."
            # 再起動
            export DB_PATH="bot.db"
            nohup python bot.py > logs/bot.log 2>&1 &
            echo $! > temp/bot.pid
            sleep 10
          fi
          # 1分ごとにチェック
          sleep 60
          echo "実行中... ($i/30分)"
        done
        
        echo "30分経過しました。ボットは実行を継続します"
        echo "次のワークフローが起動したら自然に引き継がれます"
        
        # ボットは停止せず、次のワークフローに引き継がせる
        # GitHub Actionsはタイムアウトするが、ボットは実行し続ける
    
    - name: Create automatic backup
      run: |
        if [ -f "bot.db" ]; then
          echo "🔄 自動バックアップを作成します..."
          mkdir -p backup
          
          # バックアップファイル名にタイムスタンプを付けて保存
          BACKUP_FILE="backup/auto_backup_$(date '+%Y%m%d_%H%M%S').db"
          cp bot.db "$BACKUP_FILE"
          
          echo "✅ バックアップを作成しました: $BACKUP_FILE"
          echo "📊 バックアップサイズ: $(wc -c < "$BACKUP_FILE") bytes"
          
          # バックアップファイルの数を確認（無制限に保持）
          BACKUP_COUNT=$(ls -1 backup/auto_backup_*.db 2>/dev/null | wc -l)
          echo "📁 現在のバックアップ数: $BACKUP_COUNT（無制限）"
        else
          echo "ℹ️ データベースファイルが存在しないため、バックアップを作成しません"
        fi
    
    - name: Commit database changes
      if: always()  # ボットがクラッシュしても必ず実行
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # bot.dbの変更をチェック
        DB_CHANGED=false
        if [ -f "bot.db" ]; then
          # bot.dbに変更があるかチェック
          if ! git diff --quiet "bot.db"; then
            DB_CHANGED=true
            echo "📝 bot.dbに変更があります"
          else
            # 強制的に変更を検知させるための処理
            sqlite3 bot.db "CREATE TABLE IF NOT EXISTS action_sync_marker (timestamp TEXT);"
            sqlite3 bot.db "INSERT OR REPLACE INTO action_sync_marker (timestamp) VALUES (datetime('now'));"
            DB_CHANGED=true
            echo "📝 bot.dbに強制変更マーカーを追加"
          fi
        fi
        
        # bot.dbが変更されている場合のみコミット
        if [ "$DB_CHANGED" = true ]; then
          echo "📝 bot.dbをGitHubに保存します..."
          git add bot.db
          
          # コミットをリトライ（最大3回に減らして整理）
          for i in {1..3}; do
            if git commit -m "🔄 Auto-sync bot.db - $(date '+%Y-%m-%d %H:%M:%S')"; then
              echo "✅ bot.dbをコミットしました (試行 $i)"
              break
            else
              echo "⚠️ コミット失敗、リトライします (試行 $i/3)"
              git pull --rebase origin main || true
              sleep 3
              # 最終手段：1つのクリーンなコミットにまとめる
              if [ $i -eq 3 ]; then
                echo "🔥 最終手段：クリーンなコミットを実行します"
                git add -A
                git commit -m "� Database sync - $(date '+%Y-%m-%d %H:%M:%S')" || true
              fi
            fi
          done
          
          # プッシュをリトライ（最大3回に減らす）
          for i in {1..3}; do
            if git push origin main; then
              echo "✅ bot.dbをプッシュしました (試行 $i)"
              break
            else
              echo "⚠️ プッシュ失敗、リトライします (試行 $i/3)"
              git pull --rebase origin main || true
              sleep 3
              # 最終手段：1回のみの強制プッシュ
              if [ $i -eq 3 ]; then
                echo "🔥 最終手段：強制プッシュを実行します"
                git push origin main --force || true
              fi
            fi
          done
          
          # 緊急バックアップ：1日1回のみに制限
          CURRENT_DATE=$(date +%Y%m%d)
          LAST_BACKUP_FILE="backup/.last_emergency_backup"
          if [ -f "$LAST_BACKUP_FILE" ]; then
            LAST_BACKUP_DATE=$(cat "$LAST_BACKUP_FILE")
          else
            LAST_BACKUP_DATE="0"
          fi
          
          if [ "$CURRENT_DATE" -gt "$LAST_BACKUP_DATE" ] && [ $? -ne 0 ]; then
            echo "🚨 緊急バックアップ：別ブランチに保存します"
            git checkout -b emergency-backup-$(date +%Y%m%d_%H%M%S)
            git add -A
            git commit -m "🚨 Emergency backup - $(date '+%Y-%m-%d %H:%M:%S')" || true
            git push origin emergency-backup-$(date +%Y%m%d_%H%M%S) --force || true
            git checkout main
            echo "$CURRENT_DATE" > "$LAST_BACKUP_FILE"
          fi
        else
          echo "ℹ️ bot.dbに変更はありません"
        fi
        
        # バックアップファイルの変更をチェック
        BACKUP_CHANGED=false
        if [ -d "backup" ]; then
          for backup_file in backup/auto_backup_*.db; do
            if [ -f "$backup_file" ] && ! git diff --quiet "$backup_file"; then
              BACKUP_CHANGED=true
              break
            fi
          done
        fi
        
        # バックアップファイルが変更されている場合のみコミット
        if [ "$BACKUP_CHANGED" = true ]; then
          echo "📝 バックアップファイルをGitHubに保存します..."
          git add backup/auto_backup_*.db
          
          # コミットをリトライ
          for i in {1..3}; do
            if git commit -m "📁 Update backup files - $(date '+%Y-%m-%d %H:%M:%S')"; then
              echo "✅ バックアップファイルをコミットしました (試行 $i)"
              break
            else
              echo "⚠️ コミット失敗、リトライします (試行 $i/3)"
              git pull --rebase origin main || true
              sleep 5
            fi
          done
          
          # プッシュをリトライ
          for i in {1..3}; do
            if git push origin main; then
              echo "✅ バックアップファイルをプッシュしました (試行 $i)"
              break
            else
              echo "⚠️ プッシュ失敗、リトライします (試行 $i/3)"
              git pull --rebase origin main || true
              sleep 5
            fi
          done
        else
          echo "ℹ️ バックアップファイルに変更はありません"
        fi
    
    - name: Show logs
      if: always()
      run: |
        if [ -f "logs/bot.log" ]; then
          echo "=== 最終ログ ==="
          echo "=== DEBUGログを含む全ログ ==="
          grep -E "(DEBUG|ERROR|WARNING)" logs/bot.log || echo "DEBUGログが見つかりません"
          echo "=== 最終50行 ==="
          tail -n 50 logs/bot.log
        fi
        if [ -f "bot.db" ]; then
          echo "=== データベース情報 ==="
          ls -la bot.db
          sqlite3 bot.db "SELECT COUNT(*) FROM thoughts;" || echo "データベースが存在しません"
          echo "=== 最近の投稿 ==="
          sqlite3 bot.db "SELECT id, is_anonymous, is_private, created_at FROM thoughts ORDER BY created_at DESC LIMIT 5;" || echo "投稿データが取得できません"
        fi
        
        if [ -d "backups" ]; then
          echo "=== バックアップ情報 ==="
          echo "📁 バックアップファイル一覧:"
          ls -la backups/auto_backup_*.db 2>/dev/null || ls -la backups/*.db 2>/dev/null || echo "バックアップファイルがありません"
          BACKUP_COUNT=$(ls -1 backups/*.db 2>/dev/null | wc -l)
          echo "📊 バックアップ数: $BACKUP_COUNT（無制限）"
        fi
