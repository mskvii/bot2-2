name: Discord Bot

on:
  push:
    branches: [ main ]
  workflow_dispatch:
  schedule:
    - cron: '0 */6 * * *'  # 6æ™‚é–“ã”ã¨ã«ãƒã‚§ãƒƒã‚¯ï¼ˆUTCï¼‰

jobs:
  run-bot:
    runs-on: ubuntu-latest
    
    # åŒã˜ã‚³ãƒŸãƒƒãƒˆã«å¯¾ã—ã¦åŒæ™‚ã«è¤‡æ•°ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãŒå®Ÿè¡Œã•ã‚Œãªã„ã‚ˆã†ã«ã™ã‚‹
    concurrency: 
      group: bot-${{ github.ref }}
      cancel-in-progress: true
    
    steps:
    - uses: actions/checkout@v3
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0
    
    - name: Set timezone to Japan
      run: |
        sudo timedatectl set-timezone Asia/Tokyo
        date
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.13'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Setup database directory
      run: |
        mkdir -p data backup
        chmod 755 data backup
    
    - name: Pull latest database
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git pull origin main || true
        
        # ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’ä½œæˆ
        if [ -f "data/bot.db" ]; then
          echo "æ—¢å­˜ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã—ã¾ã™"
          cp data/bot.db data/bot.db.backup.$(date +%Y%m%d_%H%M%S)
        fi
        
        # ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆè§£æ¶ˆ
        if [ -f "bot.db" ] && [ -f "data/bot.db" ]; then
          echo "ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆã‚’æ¤œå‡ºã€ãƒãƒ¼ã‚¸ã—ã¾ã™"
          # ã‚ˆã‚Šæ–°ã—ã„ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½¿ç”¨
          if [ "data/bot.db" -nt "bot.db" ]; then
            echo "data/bot.db ã‚’ä½¿ç”¨ã—ã¾ã™ï¼ˆã‚ˆã‚Šæ–°ã—ã„ï¼‰"
            cp data/bot.db bot.db
          else
            echo "bot.db ã‚’ä½¿ç”¨ã—ã¾ã™ï¼ˆã‚ˆã‚Šæ–°ã—ã„ï¼‰"
            cp bot.db data/
          fi
        elif [ -f "data/bot.db" ]; then
          echo "data/bot.db ã®ã¿å­˜åœ¨ã—ã¾ã™"
          cp data/bot.db bot.db
        elif [ -f "bot.db" ]; then
          echo "bot.db ã®ã¿å­˜åœ¨ã—ã¾ã™"
          mkdir -p data
          cp bot.db data/
        else
          echo "ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãŒå­˜åœ¨ã—ã¾ã›ã‚“"
          mkdir -p data
        fi
    
    - name: Check if database exists
      run: |
        # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®çŠ¶æ…‹ã‚’ç¢ºèª
        if [ -f "data/bot.db" ]; then
          echo "æ—¢å­˜ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚µã‚¤ã‚º: $(wc -c < data/bot.db) bytes"
          if [ -s "data/bot.db" ]; then
            echo "âœ… æ—¢å­˜ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ä½¿ç”¨ã—ã¾ã™ï¼ˆãƒ‡ãƒ¼ã‚¿ã‚ã‚Šï¼‰"
            
            # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹ã‹ç¢ºèª
            sqlite3 data/bot.db "SELECT COUNT(*) FROM thoughts;" > /tmp/db_count.txt 2>/dev/null || echo "0" > /tmp/db_count.txt
            DB_COUNT=$(cat /tmp/db_count.txt)
            echo "ğŸ“Š ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®æŠ•ç¨¿æ•°: $DB_COUNT"
            
            if [ "$DB_COUNT" -gt 0 ]; then
              echo "âœ… ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ãƒ‡ãƒ¼ã‚¿ãŒå­˜åœ¨ã—ã¾ã™ã€‚æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã‚’ä¿è­·ã—ã¾ã™ã€‚"
              # æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã‚’ä¿è­·ï¼ˆä¸Šæ›¸ãã—ãªã„ï¼‰
              if [ -f "bot.db" ]; then
                echo "âš ï¸ bot.db ã¯ç„¡è¦–ã—ã¾ã™ï¼ˆæ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã‚’ä¿è­·ï¼‰"
                rm -f bot.db
              fi
            else
              echo "âš ï¸ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¯ç©ºã§ã™"
              if [ -f "bot.db" ] && [ -s "bot.db" ]; then
                echo "ğŸ”„ bot.db ã«ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹ãŸã‚ã€ãã¡ã‚‰ã‚’ä½¿ç”¨ã—ã¾ã™"
                cp bot.db data/bot.db
              fi
            fi
          else
            echo "âš ï¸ æ—¢å­˜ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¯ç©ºã§ã™"
            if [ -f "bot.db" ] && [ -s "bot.db" ]; then
              echo "ğŸ”„ bot.db ã«ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹ãŸã‚ã€ãã¡ã‚‰ã‚’ä½¿ç”¨ã—ã¾ã™"
              cp bot.db data/bot.db
            else
              echo "ğŸ“ æ–°è¦ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ä½œæˆã—ã¾ã™"
              touch data/bot.db
            fi
          fi
        else
          echo "ğŸ“ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãŒå­˜åœ¨ã—ã¾ã›ã‚“"
          if [ -f "bot.db" ] && [ -s "bot.db" ]; then
            echo "ğŸ”„ bot.db ã‚’ä½¿ç”¨ã—ã¾ã™"
            mkdir -p data
            cp bot.db data/bot.db
          else
            echo "ğŸ“ æ–°è¦ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ä½œæˆã—ã¾ã™"
            mkdir -p data
            touch data/bot.db
          fi
        fi
        
        # æœ€çµ‚çš„ãªãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹çŠ¶æ…‹ã‚’ç¢ºèª
        if [ -f "data/bot.db" ]; then
          echo "ğŸ“Š æœ€çµ‚ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚µã‚¤ã‚º: $(wc -c < data/bot.db) bytes"
          if [ -s "data/bot.db" ]; then
            sqlite3 data/bot.db "SELECT COUNT(*) FROM thoughts;" > /tmp/final_count.txt 2>/dev/null || echo "0" > /tmp/final_count.txt
            FINAL_COUNT=$(cat /tmp/final_count.txt)
            echo "ğŸ“Š æœ€çµ‚æŠ•ç¨¿æ•°: $FINAL_COUNT"
          else
            echo "âš ï¸ æœ€çµ‚ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¯ç©ºã§ã™"
          fi
        fi
    
    - name: Check if bot is running
      id: check_bot
      env:
        DISCORD_TOKEN: ${{ secrets.DISCORD_TOKEN }}
        ALLOWED_CHANNEL_IDS: ${{ secrets.ALLOWED_CHANNEL_ID }}
      run: |
        # æ—¢å­˜ã®å®Ÿè¡Œä¸­ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’ãƒã‚§ãƒƒã‚¯
        RUNNING_JOBS=$(curl -s -H "Authorization: token ${{ github.token }}" \
          "https://api.github.com/repos/${{ github.repository }}/actions/runs?status=in_progress" | \
          jq -r '.workflow_runs[] | select(.id != ${{ github.run_id }}) | .id')
        
        if [ -z "$RUNNING_JOBS" ]; then
          echo "ãƒœãƒƒãƒˆãŒå®Ÿè¡Œã•ã‚Œã¦ã„ãªã„ãŸã‚ã€èµ·å‹•ã—ã¾ã™"
          echo "RUN_BOT=true" >> $GITHUB_ENV
        else
          echo "ãƒœãƒƒãƒˆã¯æ—¢ã«å®Ÿè¡Œä¸­ã§ã™"
          echo "RUN_BOT=false" >> $GITHUB_ENV
        fi
    
    - name: Run bot
      if: env.RUN_BOT == 'true'
      env:
        DISCORD_TOKEN: ${{ secrets.DISCORD_TOKEN }}
        ALLOWED_CHANNEL_IDS: ${{ secrets.ALLOWED_CHANNEL_ID }}
      run: |
        # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’dataãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ç§»å‹•
        if [ -f "bot.db" ]; then
          mv bot.db data/
        fi
        
        # ãƒœãƒƒãƒˆèµ·å‹•æ™‚ã«ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ‘ã‚¹ã‚’æŒ‡å®š
        export DB_PATH="data/bot.db"
        
        # æ—¢å­˜ã®ãƒ—ãƒ­ã‚»ã‚¹ã‚’çµ‚äº†
        pkill -f "python.*bot.py" || true
        
        # ãƒœãƒƒãƒˆã‚’èµ·å‹•
        nohup python bot.py > bot.log 2>&1 &
        echo $! > bot.pid
        
        # èµ·å‹•ã‚’å¾…ã¤
        sleep 10
        
        # ãƒ­ã‚°ã‚’è¡¨ç¤º
        cat bot.log
        
        # ãƒ—ãƒ­ã‚»ã‚¹ãŒå®Ÿè¡Œä¸­ã‹ç¢ºèª
        if ! ps -p $(cat bot.pid) > /dev/null; then
          echo "ãƒœãƒƒãƒˆã®èµ·å‹•ã«å¤±æ•—ã—ã¾ã—ãŸ"
          cat bot.log
          exit 1
        fi
        
        echo "ãƒœãƒƒãƒˆãŒæ­£å¸¸ã«èµ·å‹•ã—ã¾ã—ãŸ"
        
        # ç„¡é™ãƒ«ãƒ¼ãƒ—ã§å¾…æ©Ÿ
        while true; do
          # ãƒœãƒƒãƒˆãŒã¾ã å®Ÿè¡Œä¸­ã‹ç¢ºèª
          if ! ps -p $(cat bot.pid) > /dev/null; then
            echo "ãƒœãƒƒãƒˆãŒçµ‚äº†ã—ã¾ã—ãŸã€‚å†èµ·å‹•ã—ã¾ã™..."
            # å†èµ·å‹•
            export DB_PATH="data/bot.db"
            nohup python bot.py > bot.log 2>&1 &
            echo $! > bot.pid
            sleep 10
          fi
          # 1åˆ†ã”ã¨ã«ãƒã‚§ãƒƒã‚¯
          sleep 60
        done
    
    - name: Commit database changes
      if: always()
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãŒå­˜åœ¨ã—ã€å¤‰æ›´ãŒã‚ã‚‹å ´åˆã®ã¿ã‚³ãƒŸãƒƒãƒˆ
        if [ -f "data/bot.db" ]; then
          # å…ƒã®å ´æ‰€ã«ã‚‚ã‚³ãƒ”ãƒ¼
          cp data/bot.db bot.db
          
          # å¤‰æ›´ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
          if ! git diff --quiet data/bot.db bot.db; then
            git add data/bot.db bot.db
            
            # ã‚³ãƒŸãƒƒãƒˆã‚’ãƒªãƒˆãƒ©ã‚¤
            for i in {1..3}; do
              if git commit -m "ğŸ—„ï¸ Update database - $(date '+%Y-%m-%d %H:%M:%S')"; then
                echo "âœ… ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ã‚³ãƒŸãƒƒãƒˆã—ã¾ã—ãŸ (è©¦è¡Œ $i)"
                break
              else
                echo "âš ï¸ ã‚³ãƒŸãƒƒãƒˆå¤±æ•—ã€ãƒªãƒˆãƒ©ã‚¤ã—ã¾ã™ (è©¦è¡Œ $i/3)"
                git pull --rebase origin main || true
                sleep 5
              fi
            done
            
            # ãƒ—ãƒƒã‚·ãƒ¥ã‚’ãƒªãƒˆãƒ©ã‚¤
            for i in {1..3}; do
              if git push origin main; then
                echo "âœ… ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ãƒ—ãƒƒã‚·ãƒ¥ã—ã¾ã—ãŸ (è©¦è¡Œ $i)"
                break
              else
                echo "âš ï¸ ãƒ—ãƒƒã‚·ãƒ¥å¤±æ•—ã€ãƒªãƒˆãƒ©ã‚¤ã—ã¾ã™ (è©¦è¡Œ $i/3)"
                sleep 10
              fi
            done
          else
            echo "â„¹ï¸ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«å¤‰æ›´ã¯ã‚ã‚Šã¾ã›ã‚“"
          fi
        fi
    
    - name: Show logs
      if: always()
      run: |
        if [ -f bot.log ]; then
          echo "=== æœ€çµ‚ãƒ­ã‚° ==="
          echo "=== DEBUGãƒ­ã‚°ã‚’å«ã‚€å…¨ãƒ­ã‚° ==="
          grep -E "(DEBUG|ERROR|WARNING)" bot.log || echo "DEBUGãƒ­ã‚°ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
          echo "=== æœ€çµ‚50è¡Œ ==="
          tail -n 50 bot.log
        fi
        if [ -f data/bot.db ]; then
          echo "=== ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æƒ…å ± ==="
          ls -la data/
          sqlite3 data/bot.db "SELECT COUNT(*) FROM thoughts;" || echo "ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãŒå­˜åœ¨ã—ã¾ã›ã‚“"
          echo "=== æœ€è¿‘ã®æŠ•ç¨¿ ==="
          sqlite3 data/bot.db "SELECT id, is_anonymous, is_private, created_at FROM thoughts ORDER BY created_at DESC LIMIT 5;" || echo "æŠ•ç¨¿ãƒ‡ãƒ¼ã‚¿ãŒå–å¾—ã§ãã¾ã›ã‚“"
        fi
