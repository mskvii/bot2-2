name: Discord Bot

on:
  push:
    branches: [ main ]
  workflow_dispatch:
  schedule:
    - cron: '*/5 * * * *'  # 5分ごとにチェック

jobs:
  run-bot:
    runs-on: ubuntu-latest
    
    # 同じコミットに対して同時に複数のワークフローが実行されないようにする
    concurrency: 
      group: bot-${{ github.ref }}
      cancel-in-progress: true
    
    steps:
    - uses: actions/checkout@v3
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0
    
    - name: Set timezone to Japan
      run: |
        sudo timedatectl set-timezone Asia/Tokyo
        date
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.13'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        # jqをインストール
        sudo apt-get update && sudo apt-get install -y jq
    
    - name: Setup data directory
      run: |
        mkdir -p logs temp data/posts data/replies data/likes data/actions data/message_refs
        chmod 755 logs temp data data/posts data/replies data/likes data/actions data/message_refs
    
    - name: Preserve existing data
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # 既存のデータを保護（上書きしない）
        if [ -d "data" ]; then
          echo "✅ 既存のdataディレクトリを保護します"
          echo "📊 データ情報:"
          find data -name "*.json" | wc -l
          echo "投稿数: $(find data/posts -name "*.json" | wc -l)"
          echo "リプライ数: $(find data/replies -name "*.json" | wc -l)"
          echo "いいね数: $(find data/likes -name "*.json" | wc -l)"
          echo "アクション数: $(find data/actions -name "*.json" | wc -l)"
          echo "メッセージ参照数: $(find data/message_refs -name "*.json" | wc -l)"
        else
          echo "⚠️ dataディレクトリが見つかりません"
          echo "🔄 GitHubから取得を試みます..."
          git fetch origin main
          git checkout origin/main -- data/ 2>/dev/null || echo "⚠️ GitHubからの取得に失敗しました"
          
          if [ -d "data" ]; then
            echo "✅ GitHubからdataディレクトリを取得しました"
          else
            echo "⚠️ GitHubにもdataディレクトリがありません"
            echo "📝 新規に空のデータディレクトリを作成します"
            mkdir -p data/posts data/replies data/likes data/actions data/message_refs
          fi
        fi
    
    - name: Check if data exists
      run: |
        # データの状態を確認
        if [ -d "data" ]; then
          echo "既存のデータディレクトリサイズ: $(du -sh data | cut -f1)"
          if [ "$(find data -name "*.json" | wc -l)" -gt 0 ]; then
            echo "✅ 既存のデータを使用します（データあり）"
            
            # データにファイルがあるか確認
            POST_COUNT=$(find data/posts -name "*.json" | wc -l)
            REPLY_COUNT=$(find data/replies -name "*.json" | wc -l)
            LIKE_COUNT=$(find data/likes -name "*.json" | wc -l)
            ACTION_COUNT=$(find data/actions -name "*.json" | wc -l)
            MESSAGE_REF_COUNT=$(find data/message_refs -name "*.json" | wc -l)
            echo "📊 データの投稿数: $POST_COUNT"
            echo "📊 データのリプライ数: $REPLY_COUNT"
            echo "📊 データのいいね数: $LIKE_COUNT"
            echo "📊 データのアクション数: $ACTION_COUNT"
            echo "📊 データのメッセージ参照数: $MESSAGE_REF_COUNT"
            
            if [ "$POST_COUNT" -gt 0 ]; then
              echo "✅ データにデータが存在します。既存データを保護します。"
            else
              echo "⚠️ データが存在しません"
            fi
          else
            echo "⚠️ データディレクトリが存在しません"
            echo "🔄 GitHubから取得を試みます..."
            git pull origin main || echo "⚠️ GitHubからの取得に失敗しました"
            
            if [ -d "data" ]; then
              echo "✅ GitHubからデータディレクトリを取得しました"
            else
              echo "⚠️ GitHubにもデータディレクトリがありません"
              echo "📝 新規に空のデータディレクトリを作成します"
              mkdir -p data/posts data/replies data/likes data/actions data/message_refs
            fi
          fi
          
          # 最終的なデータ状態を確認
          if [ -d "data" ]; then
            echo "📊 最終データディレクトリサイズ: $(du -sh data | cut -f1)"
            FINAL_POST_COUNT=$(find data/posts -name "*.json" | wc -l)
            FINAL_REPLY_COUNT=$(find data/replies -name "*.json" | wc -l)
            FINAL_LIKE_COUNT=$(find data/likes -name "*.json" | wc -l)
            FINAL_ACTION_COUNT=$(find data/actions -name "*.json" | wc -l)
            FINAL_MESSAGE_REF_COUNT=$(find data/message_refs -name "*.json" | wc -l)
            echo "📊 最終投稿数: $FINAL_POST_COUNT"
            echo "📊 最終リプライ数: $FINAL_REPLY_COUNT"
            echo "📊 最終いいね数: $FINAL_LIKE_COUNT"
            echo "📊 最終アクション数: $FINAL_ACTION_COUNT"
            echo "📊 最終メッセージ参照数: $FINAL_MESSAGE_REF_COUNT"
          else
            echo "⚠️ 最終データディレクトリは存在しません"
          fi
        fi
    
    - name: Monitor Discord commands
      env:
        DISCORD_TOKEN: ${{ secrets.DISCORD_TOKEN }}
        CHANNEL_ID: ${{ secrets.CHANNEL_ID }}
      run: |
        echo "🔍 Discordコマンド監視を開始します..."
        
        # 最後に処理したメッセージIDを初期化
        LAST_MESSAGE_ID=""
        
        # 監視ループ（5分間）
        END_TIME=$(($(date +%s) + 300))
        
        while [ $(date +%s) -lt $END_TIME ]; do
          # Discord APIで最新メッセージを取得
          MESSAGES=$(curl -s -H "Authorization: Bot $DISCORD_TOKEN" \
            "https://discord.com/api/channels/$CHANNEL_ID/messages?limit=3" 2>/dev/null)
          
          if [ $? -eq 0 ] && [ "$MESSAGES" != "" ]; then
            # 最新メッセージを解析
            LATEST_MESSAGE=$(echo "$MESSAGES" | jq -r '.[0].content' 2>/dev/null)
            LATEST_ID=$(echo "$MESSAGES" | jq -r '.[0].id' 2>/dev/null)
            
            # 新しいメッセージかチェック
            if [ "$LATEST_ID" != "$LAST_MESSAGE_ID" ] && [ "$LATEST_ID" != "null" ]; then
              echo "📨 新しいメッセージ: $LATEST_MESSAGE"
              
              case "$LATEST_MESSAGE" in
                "!start bot"|"!bot start")
                  echo "🚀 ボット起動コマンドを受信"
                  pkill -f "python.*bot.py" 2>/dev/null || true
                  mkdir -p logs temp
                  nohup python bot.py > logs/bot.log 2>&1 &
                  BOT_PID=$!
                  echo $BOT_PID > temp/bot.pid
                  
                  # Discordに応答
                  curl -s -X POST -H "Authorization: Bot $DISCORD_TOKEN" \
                    -H "Content-Type: application/json" \
                    -d "{\"content\": \"✅ ボットを起動しました！PID: $BOT_PID\"}" \
                    "https://discord.com/api/channels/$CHANNEL_ID/messages" || true
                  ;;
                  
                "!stop bot"|"!bot stop")
                  echo "🛑 ボット停止コマンドを受信"
                  pkill -f "python.*bot.py" 2>/dev/null || true
                  
                  # Discordに応答
                  curl -s -X POST -H "Authorization: Bot $DISCORD_TOKEN" \
                    -H "Content-Type: application/json" \
                    -d '{"content": "🛑 ボットを停止しました"}' \
                    "https://discord.com/api/channels/$CHANNEL_ID/messages" || true
                  ;;
                  
                "!restart bot"|"!bot restart")
                  echo "🔄 ボット再起動コマンドを受信"
                  pkill -f "python.*bot.py" 2>/dev/null || true
                  mkdir -p logs temp
                  nohup python bot.py > logs/bot.log 2>&1 &
                  BOT_PID=$!
                  echo $BOT_PID > temp/bot.pid
                  
                  # Discordに応答
                  curl -s -X POST -H "Authorization: Bot $DISCORD_TOKEN" \
                    -H "Content-Type: application/json" \
                    -d "{\"content\": \"🔄 ボットを再起動しました！PID: $BOT_PID\"}" \
                    "https://discord.com/api/channels/$CHANNEL_ID/messages" || true
                  ;;
                  
                "!status bot"|"!bot status")
                  echo "📊 ボット状態確認コマンドを受信"
                  if [ -f temp/bot.pid ]; then
                    BOT_PID=$(cat temp/bot.pid)
                    if ps -p $BOT_PID > /dev/null 2>&1; then
                      STATUS="✅ ボットは実行中です (PID: $BOT_PID)"
                    else
                      STATUS="❌ ボットは停止しています (PIDファイルは存在します)"
                    fi
                  else
                    STATUS="❌ ボットは停止しています (PIDファイルが存在しません)"
                  fi
                  
                  # Discordに応答
                  curl -s -X POST -H "Authorization: Bot $DISCORD_TOKEN" \
                    -H "Content-Type: application/json" \
                    -d "{\"content\": \"$STATUS\"}" \
                    "https://discord.com/api/channels/$CHANNEL_ID/messages" || true
                  ;;
                  
                "!help"|"!bot help")
                  echo "❓ ヘルプコマンドを受信"
                  HELP_TEXT="🤖 **ボット操作コマンド**\n\n"
                  HELP_TEXT+="• \`!start bot\` - ボットを起動\n"
                  HELP_TEXT+="• \`!stop bot\` - ボットを停止\n"
                  HELP_TEXT+="• \`!restart bot\` - ボットを再起動\n"
                  HELP_TEXT+="• \`!status bot\` - ボットの状態を確認\n"
                  HELP_TEXT+="• \`!help\` - ヘルプを表示"
                  
                  # Discordに応答
                  curl -s -X POST -H "Authorization: Bot $DISCORD_TOKEN" \
                    -H "Content-Type: application/json" \
                    -d "{\"content\": \"$HELP_TEXT\"}" \
                    "https://discord.com/api/channels/$CHANNEL_ID/messages" || true
                  ;;
              esac
              
              LAST_MESSAGE_ID="$LATEST_ID"
            fi
          fi
          
          # 30秒待機
          sleep 30
        done
        
        echo "⏰ Discordコマンド監視を終了します"
    
    - name: Show logs
      if: always()  # ボットがクラッシュしても必ず実行
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # データ同期を無効化（安定性のため）
        echo "ℹ️ データ同期を無効化しました（ボットの安定性のため）"
        DATA_CHANGED=false
        
        # データ同期を無効化（安定性のため）
        echo "ℹ️ データ同期を無効化しました（ボットの安定性のため）"
        echo "✅ ボットのデータ保存機能は安定して動作します"
    
    - name: Show logs
      if: always()
      run: |
        if [ -f "logs/bot.log" ]; then
          echo "=== 最終ログ ==="
          echo "=== ERROR/WARNINGログを含む全ログ ==="
          grep -E "(ERROR|WARNING)" logs/bot.log || echo "ERROR/WARNINGログが見つかりません"
          echo "=== 最終50行 ==="
          tail -n 50 logs/bot.log
        fi
        if [ -d "data" ]; then
          echo "=== データ情報 ==="
          echo "📁 データディレクトリサイズ: $(du -sh data | cut -f1)"
          echo "📊 投稿数: $(find data/posts -name "*.json" | wc -l)"
          echo "📊 リプライ数: $(find data/replies -name "*.json" | wc -l)"
          echo "📊 いいね数: $(find data/likes -name "*.json" | wc -l)"
          echo "📊 アクション数: $(find data/actions -name "*.json" | wc -l)"
          echo "📊 メッセージ参照数: $(find data/message_refs -name "*.json" | wc -l)"
          echo "=== 最近の投稿 ==="
          find data/posts -name "*.json" -exec ls -lt {} + | head -5 || echo "投稿データが取得できません"
        fi
