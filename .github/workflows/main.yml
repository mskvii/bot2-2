name: Discord Bot

on:
  push:
    branches: [ main ]
  workflow_dispatch:
  schedule:
    - cron: '*/5 * * * *'  # 5åˆ†ã”ã¨ã«ãƒã‚§ãƒƒã‚¯ï¼ˆUTCï¼‰

jobs:
  run-bot:
    runs-on: ubuntu-latest
    
    # åŒã˜ã‚³ãƒŸãƒƒãƒˆã«å¯¾ã—ã¦åŒæ™‚ã«è¤‡æ•°ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãŒå®Ÿè¡Œã•ã‚Œãªã„ã‚ˆã†ã«ã™ã‚‹
    concurrency: 
      group: bot-${{ github.ref }}
      cancel-in-progress: true
    
    steps:
    - uses: actions/checkout@v3
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0
    
    - name: Set timezone to Japan
      run: |
        sudo timedatectl set-timezone Asia/Tokyo
        date
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.13'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Setup database directory
      run: |
        mkdir -p data backup
        chmod 755 data backup
    
    - name: Pull latest database
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git pull origin main || true
        
        # ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’ä½œæˆ
        if [ -f "bot.db" ]; then
          echo "æ—¢å­˜ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã—ã¾ã™"
          cp bot.db bot.db.backup.$(date +%Y%m%d_%H%M%S)
        fi
        
        # ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆè§£æ¶ˆ
        if [ -f "bot.db" ]; then
          echo "âœ… bot.db ã‚’ä½¿ç”¨ã—ã¾ã™"
        else
          echo "ğŸ“ æ–°è¦ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ä½œæˆã—ã¾ã™"
          touch bot.db
        fi
    
    - name: Check if database exists
      run: |
        # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®çŠ¶æ…‹ã‚’ç¢ºèª
        if [ -f "bot.db" ]; then
          echo "æ—¢å­˜ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚µã‚¤ã‚º: $(wc -c < bot.db) bytes"
          if [ -s "bot.db" ]; then
            echo "âœ… æ—¢å­˜ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ä½¿ç”¨ã—ã¾ã™ï¼ˆãƒ‡ãƒ¼ã‚¿ã‚ã‚Šï¼‰"
            
            # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹ã‹ç¢ºèª
            sqlite3 bot.db "SELECT COUNT(*) FROM thoughts;" > /tmp/db_count.txt 2>/dev/null || echo "0" > /tmp/db_count.txt
            DB_COUNT=$(cat /tmp/db_count.txt)
            echo "ğŸ“Š ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®æŠ•ç¨¿æ•°: $DB_COUNT"
            
            if [ "$DB_COUNT" -gt 0 ]; then
              echo "âœ… ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ãƒ‡ãƒ¼ã‚¿ãŒå­˜åœ¨ã—ã¾ã™ã€‚æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã‚’ä¿è­·ã—ã¾ã™ã€‚"
              # æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã‚’ä¿è­·ï¼ˆä¸Šæ›¸ãã—ãªã„ï¼‰
              if [ -f "bot.db" ]; then
                echo "âš ï¸ bot.db ã¯ç„¡è¦–ã—ã¾ã™ï¼ˆæ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã‚’ä¿è­·ï¼‰"
                # rm -f bot.db  # â† å‰Šé™¤ï¼š5åˆ†ã”ã¨ã«bot.dbã‚’æ¶ˆã•ãªã„ã‚ˆã†ã«ã™ã‚‹
              fi
            else
              echo "âš ï¸ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¯ç©ºã§ã™"
              # ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‹ã‚‰è‡ªå‹•å¾©å…ƒã‚’è©¦ã¿ã‚‹
              echo "ğŸ”„ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‹ã‚‰ã®è‡ªå‹•å¾©å…ƒã‚’è©¦ã¿ã¾ã™..."
              if [ -d "backup" ] && [ "$(ls -1 backup/*.db 2>/dev/null | wc -l)" -gt 0 ]; then
                LATEST_BACKUP=$(ls -1t backup/*.db 2>/dev/null | head -n 1)
                echo "ğŸ“ æœ€æ–°ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—: $LATEST_BACKUP"
                cp "$LATEST_BACKUP" bot.db
                echo "âœ… ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‹ã‚‰å¾©å…ƒã—ã¾ã—ãŸ"
                
                # å¾©å…ƒå¾Œã®ç¢ºèª
                RESTORED_COUNT=$(sqlite3 bot.db "SELECT COUNT(*) FROM thoughts;" 2>/dev/null || echo "0")
                echo "ğŸ“Š å¾©å…ƒå¾Œã®æŠ•ç¨¿æ•°: $RESTORED_COUNT"
                if [ "$RESTORED_COUNT" -gt 0 ]; then
                  echo "âœ… ãƒ‡ãƒ¼ã‚¿å¾©å…ƒã«æˆåŠŸã—ã¾ã—ãŸ"
                else
                  echo "âš ï¸ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚‚ç©ºã§ã—ãŸ"
                fi
              else
                echo "âš ï¸ åˆ©ç”¨å¯èƒ½ãªãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãŒã‚ã‚Šã¾ã›ã‚“"
              fi
            fi
          else
            echo "âš ï¸ æ—¢å­˜ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¯ç©ºã§ã™"
            # ä¸Šè¨˜ã®å¾©å…ƒãƒ­ã‚¸ãƒƒã‚¯ã§å‡¦ç†ã•ã‚Œã‚‹ãŸã‚ã€ã“ã“ã§ã¯ä½•ã‚‚ã—ãªã„
          fi
        else
          echo "ğŸ“ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãŒå­˜åœ¨ã—ã¾ã›ã‚“"
          echo "ğŸ“ æ–°è¦ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ä½œæˆã—ã¾ã™"
          touch bot.db
        fi
        
        # æœ€çµ‚çš„ãªãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹çŠ¶æ…‹ã‚’ç¢ºèª
        if [ -f "bot.db" ]; then
          echo "ğŸ“Š æœ€çµ‚ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚µã‚¤ã‚º: $(wc -c < bot.db) bytes"
          if [ -s "bot.db" ]; then
            sqlite3 bot.db "SELECT COUNT(*) FROM thoughts;" > /tmp/final_count.txt 2>/dev/null || echo "0" > /tmp/final_count.txt
            FINAL_COUNT=$(cat /tmp/final_count.txt)
            echo "ğŸ“Š æœ€çµ‚æŠ•ç¨¿æ•°: $FINAL_COUNT"
          else
            echo "âš ï¸ æœ€çµ‚ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¯ç©ºã§ã™"
          fi
        fi
    
    - name: Check if bot is running
      id: check_bot
      env:
        DISCORD_TOKEN: ${{ secrets.DISCORD_TOKEN }}
        ALLOWED_CHANNEL_IDS: ${{ secrets.ALLOWED_CHANNEL_ID }}
      run: |
        # æ—¢å­˜ã®å®Ÿè¡Œä¸­ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’ãƒã‚§ãƒƒã‚¯
        RUNNING_JOBS=$(curl -s -H "Authorization: token ${{ github.token }}" \
          "https://api.github.com/repos/${{ github.repository }}/actions/runs?status=in_progress" | \
          jq -r '.workflow_runs[] | select(.id != ${{ github.run_id }}) | .id')
        
        if [ -z "$RUNNING_JOBS" ]; then
          echo "ãƒœãƒƒãƒˆãŒå®Ÿè¡Œã•ã‚Œã¦ã„ãªã„ãŸã‚ã€èµ·å‹•ã—ã¾ã™"
          echo "RUN_BOT=true" >> $GITHUB_ENV
        else
          echo "ãƒœãƒƒãƒˆã¯æ—¢ã«å®Ÿè¡Œä¸­ã§ã™"
          echo "RUN_BOT=false" >> $GITHUB_ENV
        fi
    
    - name: Run bot
      if: env.RUN_BOT == 'true'
      env:
        DISCORD_TOKEN: ${{ secrets.DISCORD_TOKEN }}
        ALLOWED_CHANNEL_IDS: ${{ secrets.ALLOWED_CHANNEL_ID }}
      run: |
        # ãƒœãƒƒãƒˆèµ·å‹•æ™‚ã«ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ‘ã‚¹ã‚’æŒ‡å®š
        export DB_PATH="bot.db"
        
        # æ—¢å­˜ã®ãƒ—ãƒ­ã‚»ã‚¹ã‚’çµ‚äº†
        pkill -f "python.*bot.py" || true
        
        # ãƒœãƒƒãƒˆã‚’èµ·å‹•
        nohup python bot.py > bot.log 2>&1 &
        echo $! > bot.pid
        
        # èµ·å‹•ã‚’å¾…ã¤
        sleep 10
        
        # ãƒ­ã‚°ã‚’è¡¨ç¤º
        cat bot.log
        
        # ãƒ—ãƒ­ã‚»ã‚¹ãŒå®Ÿè¡Œä¸­ã‹ç¢ºèª
        if ! ps -p $(cat bot.pid) > /dev/null; then
          echo "ãƒœãƒƒãƒˆã®èµ·å‹•ã«å¤±æ•—ã—ã¾ã—ãŸ"
          cat bot.log
          exit 1
        fi
        
        echo "ãƒœãƒƒãƒˆãŒæ­£å¸¸ã«èµ·å‹•ã—ã¾ã—ãŸ"
        
        # ç„¡é™ãƒ«ãƒ¼ãƒ—ã§å¾…æ©Ÿ
        while true; do
          # ãƒœãƒƒãƒˆãŒã¾ã å®Ÿè¡Œä¸­ã‹ç¢ºèª
          if ! ps -p $(cat bot.pid) > /dev/null; then
            echo "ãƒœãƒƒãƒˆãŒçµ‚äº†ã—ã¾ã—ãŸã€‚å†èµ·å‹•ã—ã¾ã™..."
            # å†èµ·å‹•
            export DB_PATH="bot.db"
            nohup python bot.py > bot.log 2>&1 &
            echo $! > bot.pid
            sleep 10
          fi
          # 1åˆ†ã”ã¨ã«ãƒã‚§ãƒƒã‚¯
          sleep 60
        done
    
    - name: Create automatic backup
      run: |
        if [ -f "bot.db" ]; then
          echo "ğŸ”„ è‡ªå‹•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’ä½œæˆã—ã¾ã™..."
          mkdir -p backup
          
          # ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ•ã‚¡ã‚¤ãƒ«åã«ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã‚’ä»˜ã‘ã¦ä¿å­˜
          BACKUP_FILE="backup/auto_backup_$(date '+%Y%m%d_%H%M%S').db"
          cp bot.db "$BACKUP_FILE"
          
          echo "âœ… ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’ä½œæˆã—ã¾ã—ãŸ: $BACKUP_FILE"
          echo "ğŸ“Š ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚µã‚¤ã‚º: $(wc -c < "$BACKUP_FILE") bytes"
          
          # ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ•ã‚¡ã‚¤ãƒ«ã®æ•°ã‚’ç¢ºèªï¼ˆç„¡åˆ¶é™ã«ä¿æŒï¼‰
          BACKUP_COUNT=$(ls -1 backup/auto_backup_*.db 2>/dev/null | wc -l)
          echo "ğŸ“ ç¾åœ¨ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—æ•°: $BACKUP_COUNTï¼ˆç„¡åˆ¶é™ï¼‰"
        else
          echo "â„¹ï¸ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã—ãªã„ãŸã‚ã€ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’ä½œæˆã—ã¾ã›ã‚“"
        fi
    
    - name: Commit database changes
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿ã‚³ãƒŸãƒƒãƒˆï¼ˆbot.dbã¯è‡ªå‹•ã‚³ãƒŸãƒƒãƒˆã—ãªã„ï¼‰
        if [ -d "backup" ]; then
          # ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ•ã‚¡ã‚¤ãƒ«ã®å¤‰æ›´ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
          BACKUP_CHANGED=false
          for backup_file in backup/auto_backup_*.db; do
            if [ -f "$backup_file" ] && ! git diff --quiet "$backup_file"; then
              BACKUP_CHANGED=true
              break
            fi
          done
          
          if [ "$BACKUP_CHANGED" = true ]; then
            git add backup/auto_backup_*.db
            
            # ã‚³ãƒŸãƒƒãƒˆã‚’ãƒªãƒˆãƒ©ã‚¤
            for i in {1..3}; do
              if git commit -m "ï¿½ Update backup files - $(date '+%Y-%m-%d %H:%M:%S')"; then
                echo "âœ… ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚³ãƒŸãƒƒãƒˆã—ã¾ã—ãŸ (è©¦è¡Œ $i)"
                break
              else
                echo "âš ï¸ ã‚³ãƒŸãƒƒãƒˆå¤±æ•—ã€ãƒªãƒˆãƒ©ã‚¤ã—ã¾ã™ (è©¦è¡Œ $i/3)"
                git pull --rebase origin main || true
                sleep 5
              fi
            done
            
            # ãƒ—ãƒƒã‚·ãƒ¥ã‚’ãƒªãƒˆãƒ©ã‚¤
            for i in {1..3}; do
              if git push origin main; then
                echo "âœ… ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ—ãƒƒã‚·ãƒ¥ã—ã¾ã—ãŸ (è©¦è¡Œ $i)"
                break
              else
                echo "âš ï¸ ãƒ—ãƒƒã‚·ãƒ¥å¤±æ•—ã€ãƒªãƒˆãƒ©ã‚¤ã—ã¾ã™ (è©¦è¡Œ $i/3)"
                git pull --rebase origin main || true
                sleep 5
              fi
            done
          else
            echo "â„¹ï¸ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ•ã‚¡ã‚¤ãƒ«ã®å¤‰æ›´ã¯ã‚ã‚Šã¾ã›ã‚“"
          fi
        else
          echo "â„¹ï¸ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒå­˜åœ¨ã—ã¾ã›ã‚“"
        fi
    
    - name: Show logs
      if: always()
      run: |
        if [ -f bot.log ]; then
          echo "=== æœ€çµ‚ãƒ­ã‚° ==="
          echo "=== DEBUGãƒ­ã‚°ã‚’å«ã‚€å…¨ãƒ­ã‚° ==="
          grep -E "(DEBUG|ERROR|WARNING)" bot.log || echo "DEBUGãƒ­ã‚°ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
          echo "=== æœ€çµ‚50è¡Œ ==="
          tail -n 50 bot.log
        fi
        if [ -f bot.db ]; then
          echo "=== ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æƒ…å ± ==="
          ls -la bot.db
          sqlite3 bot.db "SELECT COUNT(*) FROM thoughts;" || echo "ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãŒå­˜åœ¨ã—ã¾ã›ã‚“"
          echo "=== æœ€è¿‘ã®æŠ•ç¨¿ ==="
          sqlite3 bot.db "SELECT id, is_anonymous, is_private, created_at FROM thoughts ORDER BY created_at DESC LIMIT 5;" || echo "æŠ•ç¨¿ãƒ‡ãƒ¼ã‚¿ãŒå–å¾—ã§ãã¾ã›ã‚“"
        fi
        
        if [ -d "backup" ]; then
          echo "=== ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—æƒ…å ± ==="
          echo "ğŸ“ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§:"
          ls -la backup/auto_backup_*.db 2>/dev/null || echo "ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚Šã¾ã›ã‚“"
          BACKUP_COUNT=$(ls -1 backup/auto_backup_*.db 2>/dev/null | wc -l)
          echo "ğŸ“Š ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—æ•°: $BACKUP_COUNTï¼ˆç„¡åˆ¶é™ï¼‰"
        fi
